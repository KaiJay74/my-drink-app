<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA 滿版與 iOS 優化 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="手搖紀錄">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0ea5e9">
    
    <!-- 桌面圖示 -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3054/3054889.png">
    
    <title>我超愛喝手搖 2026</title>
    
    <!-- 引入外部資源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #f8fafc;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        #root {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .scroll-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .scroll-container::-webkit-scrollbar {
            display: none;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slideUp 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDK 必須先載入 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 將 Firebase 實例掛載到 window 以供 Babel 腳本使用
        window.FirebaseSDK = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 重要：手動部署設定 ---
        const firebaseConfig = {
            apiKey: "你的_API_KEY",
            authDomain: "你的_PROJECT_ID.firebaseapp.com",
            projectId: "你的_PROJECT_ID",
            storageBucket: "你的_PROJECT_ID.appspot.com",
            messagingSenderId: "你的_SENDER_ID",
            appId: "你的_APP_ID"
        };
        
        const appId = 'my-drink-app';

        function App() {
            const [user, setUser] = useState(null);
            const [allRecords, setAllRecords] = useState({});
            const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1));
            const [selectedDate, setSelectedDate] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isDemo, setIsDemo] = useState(false);

            useEffect(() => {
                const initFirebase = async () => {
                    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, onSnapshot } = window.FirebaseSDK;

                    if (firebaseConfig.apiKey === "你的_API_KEY") {
                        setIsDemo(true);
                        setLoading(false);
                        return;
                    }

                    try {
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const db = getFirestore(app);

                        await signInAnonymously(auth);
                        onAuthStateChanged(auth, (u) => {
                            setUser(u);
                            if (u) {
                                const docRef = doc(db, 'artifacts', appId, 'users', u.uid, 'records', 'yearly2026');
                                onSnapshot(docRef, (docSnap) => {
                                    if (docSnap.exists()) setAllRecords(docSnap.data().data || {});
                                    setLoading(false);
                                }, (error) => {
                                    setLoading(false);
                                });
                            }
                        });
                    } catch (e) {
                        setIsDemo(true);
                        setLoading(false);
                    }
                };
                
                initFirebase();
            }, []);

            const saveToCloud = async (newData) => {
                if (isDemo) {
                    setAllRecords(newData);
                    return;
                }
                if (!user) return;
                try {
                    const { getFirestore, doc, setDoc } = window.FirebaseSDK;
                    const db = getFirestore();
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'records', 'yearly2026'), {
                        data: newData,
                        lastUpdated: new Date().toISOString()
                    });
                } catch (e) {
                    console.error("Save error", e);
                }
            };

            const stats = useMemo(() => {
                const data = Object.values(allRecords).flat().filter(r => r && r.name);
                return {
                    totalCups: data.length,
                    totalCost: data.reduce((sum, item) => sum + (Number(item.price) || 0), 0)
                };
            }, [allRecords]);

            if (loading) return (
                <div className="h-full flex flex-col items-center justify-center bg-sky-50 text-sky-500">
                    <div className="animate-bounce mb-4"><i data-lucide="cup-soda" style={{width: 64, height: 64}}></i></div>
                    <p className="font-black text-xs tracking-widest uppercase">載入中...</p>
                </div>
            );

            return (
                <div className="h-full flex flex-col">
                    <div className="bg-sky-500 pt-[env(safe-area-inset-top)] shrink-0 shadow-lg">
                        <div className="px-6 py-4 flex justify-between items-center text-white">
                            <h1 className="font-black text-xl flex items-center gap-2">
                                <i data-lucide="cup-soda"></i> 手搖紀錄 2026
                            </h1>
                            <div className={`px-3 py-1 rounded-full text-[10px] font-bold ${isDemo ? 'bg-orange-400' : 'bg-white/20'}`}>
                                {isDemo ? '預覽模式' : '雲端同步中'}
                            </div>
                        </div>
                    </div>

                    <div className="scroll-container bg-slate-50 p-6 space-y-6">
                        {isDemo && (
                            <div className="bg-orange-50 border border-orange-100 p-4 rounded-2xl text-orange-600 text-[10px] font-bold">
                                提醒：請至代碼中替換 Firebase 金鑰以啟用雲端存取。
                            </div>
                        )}
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-white rounded-[2rem] p-5 shadow-sm border border-slate-100 h-28 flex flex-col justify-between">
                                <span className="text-[10px] font-black text-slate-400 tracking-widest uppercase">總杯數</span>
                                <span className="text-3xl font-black text-sky-600 leading-none">{stats.totalCups}</span>
                            </div>
                            <div className="bg-white rounded-[2rem] p-5 shadow-sm border border-slate-100 h-28 flex flex-col justify-between">
                                <span className="text-[10px] font-black text-slate-400 tracking-widest uppercase">總支出</span>
                                <span className="text-3xl font-black text-emerald-500 leading-none">${stats.totalCost}</span>
                            </div>
                        </div>

                        <div className="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
                            <div className="p-6 bg-slate-50/50 flex justify-between items-center">
                                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))}>
                                    <i data-lucide="chevron-left" className="text-slate-300"></i>
                                </button>
                                <span className="font-black text-lg text-slate-800">
                                    {currentDate.getFullYear()}年 {currentDate.getMonth() + 1}月
                                </span>
                                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))}>
                                    <i data-lucide="chevron-right" className="text-slate-300"></i>
                                </button>
                            </div>
                            <div className="p-6">
                                <div className="grid grid-cols-7 gap-2">
                                    {Array.from({ length: new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate() }).map((_, i) => {
                                        const day = i + 1;
                                        const key = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}-${day}`;
                                        const hasData = allRecords[key]?.some(r => r.name);
                                        return (
                                            <button 
                                                key={day}
                                                onClick={() => setSelectedDate(day)}
                                                className={`aspect-square rounded-2xl flex items-center justify-center font-black text-sm transition-all
                                                    ${hasData ? 'bg-sky-500 text-white shadow-lg scale-105' : 'bg-slate-50 text-slate-400 active:bg-slate-100'}`}
                                            >
                                                {day}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white/80 backdrop-blur-xl border-t border-slate-100 px-10 pt-4 pb-[calc(env(safe-area-inset-bottom)+1rem)] flex justify-around shrink-0">
                        <button className="text-sky-500 flex flex-col items-center gap-1">
                            <i data-lucide="calendar"></i>
                            <span className="text-[10px] font-bold">日誌</span>
                        </button>
                        <button className="text-slate-300 flex flex-col items-center gap-1">
                            <i data-lucide="sparkles"></i>
                            <span className="text-[10px] font-bold">分析</span>
                        </button>
                    </div>

                    {selectedDate && (
                        <div className="fixed inset-0 bg-white z-[100] flex flex-col pt-[env(safe-area-inset-top)] animate-slide-up">
                            <div className="px-6 py-4 border-b flex justify-between items-center bg-white sticky top-0">
                                <button onClick={() => setSelectedDate(null)} className="text-slate-300"><i data-lucide="x" style={{width: 32, height: 32}}></i></button>
                                <span className="font-black text-lg">{currentDate.getMonth() + 1}月{selectedDate}日 紀錄</span>
                                <button 
                                    onClick={() => { saveToCloud(allRecords); setSelectedDate(null); }}
                                    className="bg-sky-500 text-white px-6 py-2 rounded-2xl font-black text-sm shadow-md"
                                >
                                    儲存
                                </button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50/30 pb-20">
                                {[0, 1].map(idx => {
                                    const dKey = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}-${selectedDate}`;
                                    const data = (allRecords[dKey] && allRecords[dKey][idx]) || {};
                                    return (
                                        <div key={idx} className="bg-white rounded-[2.5rem] p-6 space-y-4 shadow-sm border border-slate-100">
                                            <div className="text-[10px] font-black text-slate-300 tracking-widest uppercase">第 {idx + 1} 杯</div>
                                            <div className="space-y-3">
                                                <input 
                                                    type="text" 
                                                    placeholder="哪家手搖店？" 
                                                    value={data.shop || ''}
                                                    onChange={(e) => {
                                                        const updated = {...allRecords};
                                                        if(!updated[dKey]) updated[dKey] = [{}, {}];
                                                        updated[dKey][idx].shop = e.target.value;
                                                        setAllRecords(updated);
                                                    }}
                                                    className="w-full bg-slate-50 p-5 rounded-3xl font-bold outline-none border border-transparent focus:border-sky-100 transition-all"
                                                />
                                                <input 
                                                    type="text" 
                                                    placeholder="喝什麼品項？" 
                                                    value={data.name || ''}
                                                    onChange={(e) => {
                                                        const updated = {...allRecords};
                                                        if(!updated[dKey]) updated[dKey] = [{}, {}];
                                                        updated[dKey][idx].name = e.target.value;
                                                        setAllRecords(updated);
                                                    }}
                                                    className="w-full bg-slate-50 p-5 rounded-3xl font-bold outline-none border border-transparent focus:border-sky-100 transition-all"
                                                />
                                                <input 
                                                    type="number" 
                                                    placeholder="這杯多少錢？" 
                                                    value={data.price || ''}
                                                    onChange={(e) => {
                                                        const updated = {...allRecords};
                                                        if(!updated[dKey]) updated[dKey] = [{}, {}];
                                                        updated[dKey][idx].price = e.target.value;
                                                        setAllRecords(updated);
                                                    }}
                                                    className="w-full bg-slate-50 p-5 rounded-3xl font-bold outline-none border border-transparent focus:border-sky-100 transition-all"
                                                />
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        setInterval(() => lucide.createIcons(), 500);
    </script>
</body>
</html>
